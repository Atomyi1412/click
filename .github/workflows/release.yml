name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.0)'
        required: true
        default: 'v1.0.0'
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: 'x64'

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install PyInstaller==6.13.0

      - name: Build Windows compatible version
        shell: bash
        run: |
          python build_windows_compatible.py

      - name: Create portable package
        shell: bash
        run: |
          cd release/windows_compatible
          7z a -tzip ../../MouseClicker_Win11_Compatible_Portable.zip MouseClicker_Win11_Compat/ Start_MouseClicker_Win11_Compat.bat README_Windows_Compatible.md
          cd ../..
          ls -la MouseClicker_Win11_Compatible_Portable.zip

      - name: Build legacy single-file version
        shell: bash
        run: |
          python build_windows.py

      - name: Create legacy package
        shell: bash
        run: |
          cd release/windows
          7z a -tzip ../../MouseClicker_Win11_Legacy.zip MouseClicker_Win11.exe Start_MouseClicker.bat README_Windows11_Fix.md
          cd ../..
          ls -la MouseClicker_Win11_Legacy.zip

      - name: Get version
        id: get_version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          release_name: é¼ æ ‡è¿ç‚¹å™¨ ${{ steps.get_version.outputs.version }}
          body: |
            ## ğŸš€ é¼ æ ‡è¿ç‚¹å™¨ ${{ steps.get_version.outputs.version }}
            
            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            
            **æ¨èä¸‹è½½**ï¼š
            - `MouseClicker_Win11_Compatible_Portable.zip` - **Windows 11 å…¼å®¹ç‰ˆï¼ˆæ¨èï¼‰**
              - è§£å†³äº†"æ­¤åº”ç”¨æ— æ³•åœ¨ä½ çš„ç”µè„‘ä¸Šè¿è¡Œ"é—®é¢˜
              - çœŸæ­£çš„ 64 ä½ Windows å¯æ‰§è¡Œæ–‡ä»¶
              - å…å®‰è£…ï¼Œè§£å‹å³ç”¨
              - åŒ…å«æ‰€æœ‰å¿…è¦çš„è¿è¡Œæ—¶åº“
            
            **å¤‡ç”¨ç‰ˆæœ¬**ï¼š
            - `MouseClicker_Win11_Legacy.zip` - ä¼ ç»Ÿå•æ–‡ä»¶ç‰ˆ
              - å¦‚æœå…¼å®¹ç‰ˆæ— æ³•ä½¿ç”¨ï¼Œå¯å°è¯•æ­¤ç‰ˆæœ¬
            
            ### âœ¨ ä¸»è¦åŠŸèƒ½
            - ğŸ–±ï¸ é¼ æ ‡è‡ªåŠ¨è¿ç‚¹ï¼ˆæ”¯æŒå·¦é”®/å³é”®/ä¸­é”®ï¼‰
            - âŒ¨ï¸ å…¨å±€çƒ­é”®æ§åˆ¶ï¼ˆCtrl+Alt+S å¼€å§‹ï¼ŒCtrl+Alt+D åœæ­¢ï¼‰
            - âš™ï¸ å¯è‡ªå®šä¹‰ç‚¹å‡»é¢‘ç‡ï¼ˆ1-100æ¬¡/ç§’ï¼‰
            - ğŸ’¾ è‡ªåŠ¨ä¿å­˜é…ç½®
            - ğŸ¯ æ”¯æŒæŒ‡å®šç‚¹å‡»æ¬¡æ•°æˆ–æ— é™åˆ¶
            
            ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½ `MouseClicker_Win11_Compatible_Portable.zip`
            2. è§£å‹åˆ°ä»»æ„æ–‡ä»¶å¤¹
            3. åŒå‡» `Start_MouseClicker_Win11_Compat.bat` å¯åŠ¨
            4. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å…è®¸ Windows Defender è­¦å‘Š
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - å»ºè®®ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œä»¥ç¡®ä¿å…¨å±€çƒ­é”®åŠŸèƒ½
            - è¯·éµå®ˆç›¸å…³è½¯ä»¶ä½¿ç”¨åè®®ï¼Œä¸è¦ç”¨äºè¿è§„ç”¨é€”
            - æ”¯æŒ Windows 10/11 64ä½ç³»ç»Ÿ
            
            ### ğŸ› é—®é¢˜åé¦ˆ
            å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ Issues ä¸­åé¦ˆï¼Œå¹¶æä¾›ï¼š
            - Windows ç‰ˆæœ¬ä¿¡æ¯
            - é”™è¯¯æˆªå›¾
            - å…·ä½“ä½¿ç”¨åœºæ™¯
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}

      - name: Upload Compatible Version
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./MouseClicker_Win11_Compatible_Portable.zip
          asset_name: MouseClicker_Win11_Compatible_Portable.zip
          asset_content_type: application/zip

      - name: Upload Legacy Version
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./MouseClicker_Win11_Legacy.zip
          asset_name: MouseClicker_Win11_Legacy.zip
          asset_content_type: application/zip

      - name: Upload Artifacts for Testing
        uses: actions/upload-artifact@v4
        with:
          name: Release_Packages_${{ steps.get_version.outputs.version }}
          path: |
            MouseClicker_Win11_Compatible_Portable.zip
            MouseClicker_Win11_Legacy.zip
            release/windows_compatible/**
            release/windows/**